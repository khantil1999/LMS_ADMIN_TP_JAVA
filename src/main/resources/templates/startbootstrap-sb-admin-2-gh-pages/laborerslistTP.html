<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>SB Admin 2 - Labourers List</title>

  <!-- Custom fonts for this template-->
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link
          href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
          rel="stylesheet">

  <!-- Custom styles for this template-->
  <link href="/css/sb-admin-2.min.css" rel="stylesheet">
  <style>
    .buttons-container {
      display: flex;
      column-gap: 10px;
    }
    .pdf-button{
      background: #e74a3b !important;
      border: #e74a3b !important;
      color: white !important;
    }
    .add-btn{
      background: #4e73df !important;
      border: #4e73df !important;
      color: white !important;
    }
  </style>
</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

  <!-- Sidebar -->
  <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

    <!-- Sidebar - Brand -->
    <a class="sidebar-brand d-flex align-items-center justify-content-center" th:href="@{/dashboardTP}">
      <div class="sidebar-brand-text mx-3"> Provider </div>
    </a>

    <!-- Divider -->
    <hr class="sidebar-divider my-0">

    <!-- Nav Item - Dashboard -->
    <li class="nav-item active">
      <a class="nav-link" th:href="@{/dashboardTP}">
        <i class="fas fa-fw fa-tachometer-alt"></i>
        <span>Dashboard</span></a>
    </li>

    <!-- Divider -->
    <hr class="sidebar-divider">

    <!-- Nav Item - Pages Collapse Menu -->
    <li class="nav-item">
      <a class="nav-link collapsed" th:href="@{/vehiclelistTP}" >
        <span>Vehicle Lists</span>
      </a>
    </li>

    <!-- Nav Item - Charts -->
    <li class="nav-item">
      <a class="nav-link" th:href="@{/laborerslistTP}">
        <span>Laborers List</span></a>
    </li>

    <!-- Nav Item - Tables -->
    <li class="nav-item">
      <a class="nav-link" th:href="@{/bookingTP}">
        <span>Booking</span></a>
    </li>

    <li class="nav-item">
      <a class="nav-link" th:href="@{/pastbooking}">
        <span>Past Booking</span></a>
    </li>

    <!-- Divider -->
    <hr class="sidebar-divider d-none d-md-block">

    <!-- Sidebar Toggler (Sidebar) -->
    <div class="text-center d-none d-md-inline">
      <button class="rounded-circle border-0" id="sidebarToggle"></button>
    </div>

  </ul>
  <!-- End of Sidebar -->

  <!-- Content Wrapper -->
  <div id="content-wrapper" class="d-flex flex-column">

    <!-- Main Content -->
    <div id="content">


      <!-- Topbar -->
      <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

        <!-- Sidebar Toggle (Topbar) -->
        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
          <i class="fa fa-bars"></i>
        </button>



        <!-- Topbar Navbar -->
        <ul class="navbar-nav ml-auto">
          <!-- Nav Item - User Information -->
          <li class="nav-item dropdown no-arrow">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="mr-2 d-none d-lg-inline text-gray-600 small">Provider</span>
              <img class="img-profile rounded-circle"
                   src="img/undraw_profile.svg">
            </a>
            <!-- Dropdown - User Information -->
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                 aria-labelledby="userDropdown">
              <a class="dropdown-item" th:href="@{/profileTP}">
                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                Profile
              </a>
              <a class="dropdown-item" th:href="@{/changePasswordTP}">
                <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                change password
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                Logout
              </a>
            </div>
          </li>

        </ul>

      </nav>
      <!-- End of Topbar -->

      <!-- Begin Page Content -->
      <div class="container-fluid">

        <div class="container">
          <div class="row col-md-20">
            <h2>List of Registered Laborers</h2>
          </div>

          <table  id="labourTable" class="table table-bordered table-hover">
            <thead class="table-dark" style="background-color: #7784d6;">
            <tr>
              <th>Sr. No</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Mobile No</th>
              <th>Email</th>
              <th>Action</th>
            </tr>
            </thead>
            <tbody id="labourTableBody">
            </tbody>
          </table>
        </div>
        <!-- Content Row -->
      </div>

    </div>
    <!-- /.container-fluid -->

  <!-- End of Main Content -->

<!-- Footer -->
<footer class="sticky-footer bg-white">
  <div class="container my-auto">
    <div class="copyright text-center my-auto">
      <span>Copyright &copy; Logistic Management System 2024</span>
    </div>
  </div>
</footer>
<!-- End of Footer -->

</div>
<!-- End of Content Wrapper -->
</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal-->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <a class="btn btn-primary"  th:href="@{/login}">Logout</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addEditLaborModel" tabindex="-1" aria-labelledby="addEditLaborsModel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addEditLaborsModel">Add Laborers</h5>
        <button onclick="closeLabourForm()" class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="addLaborerForm">
          <input type="hidden" id="user-id" value="">
          <div class="mb-3">
            <label for="first-name" class="col-form-label">First Name:</label>
            <input type="text" class="form-control" id="first-name">
            <div id="first-nameError" class="text-danger"></div>
          </div>
          <div class="mb-3">
            <label for="last-name" class="col-form-label">Last Name:</label>
            <input type="text" class="form-control" id="last-name">
            <div id="last-nameError" class="text-danger"></div>
          </div>
          <div class="mb-3">
            <label for="email" class="col-form-label">Email:</label>
            <input type="email" class="form-control" id="email">
            <div id="emailError" class="text-danger"></div>
          </div>
          <div class="mb-3">
            <label for="mobile-number" class="col-form-label">Mobile Number:</label>
            <input type="text" class="form-control" id="mobile-number">
            <div id="mobile-numberError" class="text-danger"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button onclick="closeLabourForm()" class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <button type="button" id="addBtn" class="btn btn-primary" onclick="addLaborer()">Add Labourers</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
     aria-hidden="true"  >
  <div class="modal-dialog" role="document">
    <div class="modal-content" >
      <div class="modal-header" >
        <input type="hidden" value="" id="deleteLabourId">
        <h5 class="modal-title" id="deleteModalLabel">Are you sure to delete the labourer?</h5>
        <button onclick="closeModel('deleteLabourId')" class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-footer">

        <button onclick="closeModel('deleteLabourId')" class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <button
                type="button"
                class="btn btn-primary"
                onclick="deleteLabor()">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap core JavaScript-->
<script src="/vendor/jquery/jquery.min.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/js/sb-admin-2.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<link href="https://cdn.datatables.net/v/dt/dt-2.0.2/b-3.0.1/datatables.min.css" rel="stylesheet">

<script src="https://cdn.datatables.net/v/dt/dt-2.0.2/b-3.0.1/datatables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.3.1/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>


<!-- Bootstrap Modal -->


<script th:inline="javascript">
  let profile
  $(document).ready(function (){
    getProfileDetails()
  })
  document.addEventListener('DOMContentLoaded', function() {
    const inputFields = document.querySelectorAll('#addLaborerForm input');
    inputFields.forEach(input => {
      input.addEventListener('input', () => {
        const errorId = input.id + 'Error';
        document.getElementById(errorId).innerText = '';
      });

      input.addEventListener('blur', () => {
        validateInput(input);
      });
    });
  });
  function addLaborer() {
    const inputs = ['first-name', 'last-name', 'email', 'mobile-number'];
    let isValid = true;

    inputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      isValid = validateInput(input) && isValid;
    });

    if (isValid) {
      let id =   $('#user-id').val();

      if(id){
        editLabourApi()
      }else{
        addApiCall();
      }
    }
  }

  function validateInput(input) {
    const value = input.value.trim();
    const errorId = input.id + 'Error';
    const errorMessages = {
      'first-name': 'First Name is required and can only contain alphabets and spaces',
      'last-name': 'Last Name is required and can only contain alphabets and spaces',
      'email': 'Email is required and must be a valid email address',
      'mobile-number': 'Mobile Number is required and must be a valid Indian mobile number'
    };

    if (!value) {
      document.getElementById(errorId).innerText = errorMessages[input.id] || 'This field is required';
      return false;
    } else if (input.id === 'first-name' || input.id === 'last-name') {
      const regex = /^[a-zA-Z ]+$/;
      if (!regex.test(value)) {
        document.getElementById(errorId).innerText = errorMessages[input.id] || 'Invalid format';
        return false;
      }
    } else if (input.id === 'email') {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        document.getElementById(errorId).innerText = errorMessages[input.id] || 'Invalid email format';
        return false;
      }
    } else if (input.id === 'mobile-number') {
      const regex = /^\d{10}$/;
      if (!regex.test(value)) {
        document.getElementById(errorId).innerText = errorMessages[input.id] || 'Invalid format';
        return false;
      }
    }

    return true;
  }
  function addLaborers() {

    const alertModal = new bootstrap.Modal(document.getElementById('addEditLaborModel'));
    alertModal.show();
  }
  function closeModel(id){
    $('#'+id).modal('hide');
  }
  function closeLabourForm(){
    closeModel("addEditLaborModel");
    $('#user-id').val(""); // Set the user ID in the hidden field
    $('#addEditLaborsModel').text("Add Laborers")
    $('#addBtn').text("Add")
    clearFormData();
  }
  function addApiCall() {
    const formData = {
      firstName: document.getElementById('first-name').value.trim(),
      lastName: document.getElementById('last-name').value.trim(),
      email: document.getElementById('email').value.trim(),
      mobile: document.getElementById('mobile-number').value.trim()
    };

    $.ajax({
      type: 'POST',
      url: '/labour',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function(response) {

        window.location.reload()
      },
      error: function(xhr, status, error) {


        // Handle error
      }
    });
  }

  function editLabourApi() {
    const formData = {
      firstName: document.getElementById('first-name').value.trim(),
      lastName: document.getElementById('last-name').value.trim(),
      email: document.getElementById('email').value.trim(),
      mobile: document.getElementById('mobile-number').value.trim(),
      id: document.getElementById('user-id').value.trim()
    };

    $.ajax({
      type: 'PUT',
      url: '/labour/'+formData.id,
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function(response) {
        $('#user-id').val(""); // Set the user ID in the hidden field

        $('#addBtn').text("Add")
        $('#addEditLaborsModel').text("Add Laborers")
        window.location.reload()

      },
      error: function(xhr, status, error) {

        // Handle error
      }
    });
  }
  function editLabour(id){
    console.log("id: ", id)
    fetchLabourData(id);
  }
  function fetchLabourData(userId) {
    $.ajax({
      type: 'GET',
      url: '/labour/' + userId, // Replace this with the actual endpoint to fetch labor data
      success: function(response) {
        $('#user-id').val(response.id); // Set the user ID in the hidden field
        $('#first-name').val(response.firstName);
        $('#last-name').val(response.lastName);
        $('#email').val(response.email);
        $('#mobile-number').val(response.mobile);
        $('#addBtn').text("Edit")
        $('#addEditLaborsModel').text("Edit Laborers")
        addLaborers()
      },
      error: function(xhr, status, error) {
        console.error('Failed to fetch labor data:', error);
        // Handle error
      }
    });
  }
  function   clearFormData(){
    document.getElementById('first-name').value = ""
    document.getElementById('last-name').value = ""
    document.getElementById('email').value = ""
    document.getElementById('mobile-number').value  = ""
    document.getElementById('user-id').value = ""
  }

  function openDeleteModal(id) {
    $("#deleteLabourId").val(id)
    $('#deleteModal').modal('show');
  }
  function deleteLabor(){
    let userId = $("#deleteLabourId").val()
    console.log(userId);
    $.ajax({
      type: 'DELETE',
      url: '/labour/' + userId,
      success: function(response) {
        window.location.reload();
      },
      error: function(xhr, status, error) {
        console.error('Failed to fetch labor data:', error);
        // Handle error
      }
    });
  }

  function getProfileDetails() {
    $.ajax({
      url: "/me",
      type: "GET",
      dataType: "json",
      success: function (response) {
        profile = response
        fetchLaborersData(profile.id)
      },
      error: function (xhr, status, error) {
      }
    });
  }

  function fetchLaborersData(tpId) {
    $.ajax({
      type: 'GET',
      url: '/labours?truckProviderId='+tpId,
      success: function(data) {
        // Clear existing table body
        $('#labourTableBody').empty();

        // Iterate through the fetched data and append rows to the table
        $.each(data, function(index, labourer) {
          var row = '<tr>';
          row += '<td>' + (index+1) + '</td>';
          row += '<td>' + labourer.firstName + '</td>';
          row += '<td>' + labourer.lastName + '</td>';
          row += '<td>' + labourer.mobile + '</td>';
          row += '<td>' + labourer.email + '</td>';
          row += '<td>' +
                  '<button class="btn btn-primary btn-sm edit-btn" data-id="' + labourer.id + '" onclick="editLabour($(this).data(\'id\'))">' +
                  '<i class="fas fa-edit"></i>' +
                  '</button> ' +
                  '<button class="btn btn-danger btn-sm delete-btn" data-id="' + labourer.id + '" onclick="openDeleteModal($(this).data(\'id\'))">' +
                  '<i class="fas fa-trash-alt"></i>' +
                  '</button>' +
                  '</td>';
          row += '</tr>';
          $('#labourTableBody').append(row);
        });

        $('#labourTable').DataTable({
          "dom": '<"top align-items-start d-flex justify-content-between"<"buttons-container"fl>B>rt<"bottom align-items-start d-flex justify-content-between"ip><"clear">',
          "paging": true,
          "searching": true,
          "buttons": [
            {
              extend: 'pdf',
              text: '<i class="fas fa-file-pdf"></i>',
              className: 'btn pdf-button',
              titleAttr: 'Export to PDF',
              title: 'Labour List',
              customize: function (doc) {

                doc.content[1].table.body.forEach(row => {
                  row.splice(4); // Keep only the first 7 columns
                });

              }
            },
            {
              text: '<i class="fas fa-plus"></i>',
              className: 'btn add-btn',
              titleAttr: 'Add Labour',
              action: function (e, dt, node, config) {
                addLaborers()
              }
            }
          ],
          "language": {
            "search": "",
            "searchPlaceholder": "Search...",
            "lengthMenu": "_MENU_",
            "info": "Showing _START_ to _END_ of _TOTAL_ entries"

          }

        });
      },
      error: function(xhr, status, error) {
        console.error('Failed to fetch laborers:', error);
      }
    });
  }

</script>
</body>

</html>
