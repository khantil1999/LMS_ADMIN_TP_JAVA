<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>SB Admin 2 - Labourers List</title>

  <!-- Custom fonts for this template-->
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link
          href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
          rel="stylesheet">

  <!-- Custom styles for this template-->
  <link href="/css/sb-admin-2.min.css" rel="stylesheet">

</head>

<body id="page-top">

<!-- Page Wrapper -->
<div id="wrapper">

  <!-- Sidebar -->
  <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

    <!-- Sidebar - Brand -->
    <a class="sidebar-brand d-flex align-items-center justify-content-center" th:href="@{/dashboardTP}">
      <div class="sidebar-brand-text mx-3"> Provider </div>
    </a>

    <!-- Divider -->
    <hr class="sidebar-divider my-0">

    <!-- Nav Item - Dashboard -->
    <li class="nav-item active">
      <a class="nav-link" th:href="@{/dashboardTP}">
        <i class="fas fa-fw fa-tachometer-alt"></i>
        <span>Dashboard</span></a>
    </li>

    <!-- Divider -->
    <hr class="sidebar-divider">

    <!-- Nav Item - Pages Collapse Menu -->
    <li class="nav-item">
      <a class="nav-link collapsed" th:href="@{/vehiclelistTP}" >
        <span>Vehicle Lists</span>
      </a>
    </li>

    <!-- Nav Item - Charts -->
    <li class="nav-item">
      <a class="nav-link" th:href="@{/laborerslistTP}">
        <span>Laborers List</span></a>
    </li>

    <!-- Nav Item - Tables -->
    <li class="nav-item">
      <a class="nav-link" th:href="@{/bookingTP}">
        <span>Booking</span></a>
    </li>

    <li class="nav-item">
      <a class="nav-link" th:href="@{/pastbooking}">
        <span>Past Booking</span></a>
    </li>

    <!-- Divider -->
    <hr class="sidebar-divider d-none d-md-block">

    <!-- Sidebar Toggler (Sidebar) -->
    <div class="text-center d-none d-md-inline">
      <button class="rounded-circle border-0" id="sidebarToggle"></button>
    </div>

  </ul>
  <!-- End of Sidebar -->

  <!-- Content Wrapper -->
  <div id="content-wrapper" class="d-flex flex-column">

    <!-- Main Content -->
    <div id="content">


      <!-- Topbar -->
      <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

        <!-- Sidebar Toggle (Topbar) -->
        <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
          <i class="fa fa-bars"></i>
        </button>



        <!-- Topbar Navbar -->
        <ul class="navbar-nav ml-auto">
          <!-- Nav Item - User Information -->
          <li class="nav-item dropdown no-arrow">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
               data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="mr-2 d-none d-lg-inline text-gray-600 small">Provider</span>
              <img class="img-profile rounded-circle"
                   src="img/undraw_profile.svg">
            </a>
            <!-- Dropdown - User Information -->
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                 aria-labelledby="userDropdown">
              <a class="dropdown-item" th:href="@{/profileTP}">
                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                Profile
              </a>
              <a class="dropdown-item" th:href="@{/changePasswordTP}">
                <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                change password
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                Logout
              </a>
            </div>
          </li>

        </ul>

      </nav>
      <!-- End of Topbar -->

      <!-- Begin Page Content -->
      <div class="container-fluid">

        <div class="container">
          <div class="row col-md-20">
            <h2>List of Registered Laborers</h2>
          </div>
          <form
                  th:action="@{/laborerslistTP}"
                  method="get">
            <div style="
                            display: flex;
                            justify-content: flex-end;
                            gap: 10px;">
              <div class="form-group" style="align-self: self-end;">
                <button type="button" class="btn btn-outline-primary btn-xs" id="add" onclick="addLaborers()"
                    style="color:white; background-color: #7784d6;">Add</button>
              </div>
              <div class="form-group" style="align-self: self-end;">
                <button type="button" id="exportBtn" class="btn btn-outline-primary btn-xs" style="color:white;
		                    background-color: #7784d6;">Export</button>
              </div>
            </div>
          </form><br>
          <table class="table table-bordered table-hover">
            <thead class="table-dark" style="background-color: #7784d6;">
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Mobile No</th>
              <th>Email</th>
              <th>Edit</th>
              <th>Delete</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each = "user : ${users}">
              <td th:text = "${user.firstName}"></td>
              <td th:text = "${user.lastName}"></td>
              <td th:text = "${user.mobileNo}"></td>
              <td th:text = "${user.email}"></td>
              <td class="text-center">
                <button class="btn btn-outline-primary btn-xs edit-button"
                        th:attr="data-user-id=${user.id}"
                        onclick="editLabour(this.getAttribute('data-user-id'))"
                        style="color:white; background-color: #7784d6;">Edit</button>
              </td>
              <td class="text-center">
                <a

                        class="btn btn-outline-primary btn-xs"
                        data-toggle="modal"
                        data-target="#deleteModal"
                        th:attr="data-user-id=${user.id}"
                        th:onclick="|deleteLaborers('${user.id}')|"

                        style="color:white;
                         background-color: #7784d6;">Delete</a>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
        <!-- Content Row -->
      </div>

    </div>
    <!-- /.container-fluid -->

  <!-- End of Main Content -->

<!-- Footer -->
<footer class="sticky-footer bg-white">
  <div class="container my-auto">
    <div class="copyright text-center my-auto">
      <span>Copyright &copy; Logistic Management System 2024</span>
    </div>
  </div>
</footer>
<!-- End of Footer -->

</div>
<!-- End of Content Wrapper -->
</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal-->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <a class="btn btn-primary"  th:href="@{/login}">Logout</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addEditLaborModel" tabindex="-1" aria-labelledby="addEditLaborsModel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addEditLaborsModel">Add Laborers</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="addLaborerForm">
          <input type="hidden" id="user-id" value="">
          <div class="mb-3">
            <label for="first-name" class="col-form-label">First Name:</label>
            <input type="text" class="form-control" id="first-name">
            <div id="first-nameError" class="text-danger"></div>
          </div>
          <div class="mb-3">
            <label for="last-name" class="col-form-label">Last Name:</label>
            <input type="text" class="form-control" id="last-name">
            <div id="last-nameError" class="text-danger"></div>
          </div>
          <div class="mb-3">
            <label for="email" class="col-form-label">Email:</label>
            <input type="email" class="form-control" id="email">
            <div id="emailError" class="text-danger"></div>
          </div>
          <div class="mb-3">
            <label for="mobile-number" class="col-form-label">Mobile Number:</label>
            <input type="text" class="form-control" id="mobile-number">
            <div id="mobile-numberError" class="text-danger"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button onclick="closeLabourForm()" class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <button type="button" id="addBtn" class="btn btn-primary" onclick="addLaborer()">Add Labourers</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
     aria-hidden="true"  th:each="user:${users}">
  <div class="modal-dialog" role="document">
    <div class="modal-content" >
      <div class="modal-header" >
        <input type="hidden" value="" id="deleteId">
        <h5 class="modal-title" id="deleteModalLabel">Are you sure to delete the labourer?</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-footer">

        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <a

                class="btn btn-primary"
                th:attr="data-user-id=${user.id}"
                onclick="deleteLabor(this.getAttribute('data-user-id'))">Delete</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap core JavaScript-->
<script src="/vendor/jquery/jquery.min.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/js/sb-admin-2.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<!-- Bootstrap Modal -->


<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const inputFields = document.querySelectorAll('#addLaborerForm input');
    inputFields.forEach(input => {
      input.addEventListener('input', () => {
        const errorId = input.id + 'Error';
        document.getElementById(errorId).innerText = '';
      });

      input.addEventListener('blur', () => {
        validateInput(input);
      });
    });
  });
  $('#exportBtn').click(function() {

    // Make an AJAX request to fetch data based on the date range
    $.ajax({
      method: 'GET',
      url: '/exportLabourer',
      success: function(data) {
        // Handle the success response and display the data
        var blob = new Blob([data], { type: "application/pdf" });

        // Create a link element
        var link = document.createElement("a");

        // Set the download attribute with the desired file name
        link.download = "labourer_report.pdf";

        // Create a URL for the Blob and set it as the link's href
        link.href = window.URL.createObjectURL(blob);

        // Append the link to the document
        document.body.appendChild(link);

        // Trigger a click on the link to start the download
        link.click();

        // Remove the link from the document
        document.body.removeChild(link);

      },
      error: function(error) {
        // Handle the error response
        console.error("Error fetching data:", error);
      }
    });
  });
  function addLaborer() {
    const inputs = ['first-name', 'last-name', 'email', 'mobile-number'];
    let isValid = true;

    inputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      isValid = validateInput(input) && isValid;
    });

    if (isValid) {
      let id =   $('#user-id').val();

      if(id){
        editLabourApi()
      }else{
        addApiCall();
      }
    }
  }

  function validateInput(input) {
    const value = input.value.trim();
    const errorId = input.id + 'Error';
    const errorMessages = {
      'first-name': 'First Name is required and can only contain alphabets and spaces',
      'last-name': 'Last Name is required and can only contain alphabets and spaces',
      'email': 'Email is required and must be a valid email address',
      'mobile-number': 'Mobile Number is required and must be a valid Indian mobile number'
    };

    if (!value) {
      document.getElementById(errorId).innerText = errorMessages[input.id] || 'This field is required';
      return false;
    } else if (input.id === 'first-name' || input.id === 'last-name') {
      const regex = /^[a-zA-Z ]+$/;
      if (!regex.test(value)) {
        document.getElementById(errorId).innerText = errorMessages[input.id] || 'Invalid format';
        return false;
      }
    } else if (input.id === 'email') {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        document.getElementById(errorId).innerText = errorMessages[input.id] || 'Invalid email format';
        return false;
      }
    } else if (input.id === 'mobile-number') {
      const regex = /^(?!.*(\d).*\1)[6789]\d{9}$/;
      if (!regex.test(value)) {
        document.getElementById(errorId).innerText = errorMessages[input.id] || 'Invalid format';
        return false;
      }
    }

    return true;
  }
  function addLaborers() {

    const alertModal = new bootstrap.Modal(document.getElementById('addEditLaborModel'));
    alertModal.show();
  }
  function closeLabourForm(){
    $('#user-id').val(""); // Set the user ID in the hidden field
    $('#addEditLaborsModel').text("Add Laborers")
    $('#addBtn').text("Add")
    clearFormData();
  }
  function addApiCall() {
    const formData = {
      firstName: document.getElementById('first-name').value.trim(),
      lastName: document.getElementById('last-name').value.trim(),
      email: document.getElementById('email').value.trim(),
      mobileNumber: document.getElementById('mobile-number').value.trim()
    };

    $.ajax({
      type: 'POST',
      url: '/addLabour',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function(response) {

        window.location.reload()
      },
      error: function(xhr, status, error) {


        // Handle error
      }
    });
  }

  function editLabourApi() {
    const formData = {
      firstName: document.getElementById('first-name').value.trim(),
      lastName: document.getElementById('last-name').value.trim(),
      email: document.getElementById('email').value.trim(),
      mobileNumber: document.getElementById('mobile-number').value.trim(),
      id: document.getElementById('user-id').value.trim()
    };

    $.ajax({
      type: 'PUT',
      url: '/editLabour',
      contentType: 'application/json',
      data: JSON.stringify(formData),
      success: function(response) {
        $('#user-id').val(""); // Set the user ID in the hidden field

        $('#addBtn').text("Add")
        $('#addEditLaborsModel').text("Add Laborers")
        window.location.reload()

      },
      error: function(xhr, status, error) {

        // Handle error
      }
    });
  }
  function editLabour(id){
    console.log("id: ", id)
    fetchLabourData(id);
  }
  function fetchLabourData(userId) {
    $.ajax({
      type: 'GET',
      url: '/getLabour?userId=' + userId, // Replace this with the actual endpoint to fetch labor data
      success: function(response) {
        $('#user-id').val(response.id); // Set the user ID in the hidden field
        $('#first-name').val(response.firstName);
        $('#last-name').val(response.lastName);
        $('#email').val(response.email);
        $('#mobile-number').val(response.mobileNumber);
        $('#addBtn').text("Edit")
        $('#addEditLaborsModel').text("Edit Laborers")
        addLaborers()
      },
      error: function(xhr, status, error) {
        console.error('Failed to fetch labor data:', error);
        // Handle error
      }
    });
  }
  function   clearFormData(){
    document.getElementById('first-name').value = ""
    document.getElementById('last-name').value = ""
    document.getElementById('email').value = ""
    document.getElementById('mobile-number').value  = ""
    document.getElementById('user-id').value = ""
  }
  function deleteRecord(){

  }
  function deleteLaborers(id) {
    $("#deleteId").val(id)
    const alertModal = new bootstrap.Modal(document.getElementById('deleteModel'));
    alertModal.show();
  }
  function deleteLabor(){
    let userId = $("#deleteId").val()
    console.log(userId);
    $.ajax({
      type: 'DELETE',
      url: '/labour?userId=' + userId, // Replace this with the actual endpoint to fetch labor data
      success: function(response) {
        window.location.reload();
      },
      error: function(xhr, status, error) {
        console.error('Failed to fetch labor data:', error);
        // Handle error
      }
    });
  }
</script>
</body>

</html>
