<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Register</title>

    <!-- Custom fonts for this template-->
    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
            href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
            rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="/css/sb-admin-2.min.css" rel="stylesheet">
    <style>
        .error{
            color: #e51131;
            font-size: 1rem;
            position: relative;
            line-height: 1;
        }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <style>
        #imagePreview img {
            max-width: 250px;
            max-height: 250px;
        }
    </style>
</head>

<body class="bg-gradient-primary">
<script src="https://www.gstatic.com/firebasejs/8.2.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-storage.js"></script>
<script src="/js/firebase-config.js"></script>
<div id="wrapper">

    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" th:href="@{/dashboardTP}">
            <!--                <div class="sidebar-brand-icon rotate-n-15">-->
            <!--                    <i class="fas fa-laugh-wink"></i>-->
            <!--                </div>-->
            <div class="sidebar-brand-text mx-3"> Provider </div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">

        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
            <a class="nav-link" th:href="@{/dashboardTP}">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span></a>
        </li>
        <!-- Divider -->
        <hr class="sidebar-divider">
        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
            <a class="nav-link collapsed" th:href="@{/vehiclelistTP}" >
                <span>Vehicle Lists</span>
            </a>
        </li>

        <!-- Nav Item - Charts -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/laborerslistTP}">
                <span>Laborers List</span></a>
        </li>

        <!-- Nav Item - Tables -->
        <li class="nav-item">
            <a class="nav-link" th:href="@{/bookingTP}">
                <span>Booking</span></a>
        </li>

        <li class="nav-item">
            <a class="nav-link" th:href="@{/pastbooking}">
                <span>Past Booking</span></a>
        </li>


        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block">

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
    </ul>
    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">
            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                <!-- Sidebar Toggle (Topbar) -->
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>
                <!-- Topbar Navbar -->
                <ul class="navbar-nav ml-auto">
                    <!-- Nav Item - User Information -->
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="mr-2 d-none d-lg-inline text-gray-600 small">Provider</span>
                            <img class="img-profile rounded-circle"
                                 src="img/undraw_profile.svg">
                        </a>
                        <!-- Dropdown - User Information -->
                        <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                             aria-labelledby="userDropdown">
                            <a class="dropdown-item" th:href="@{/profileTP}">
                                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                                Profile
                            </a>
                            <a class="dropdown-item" th:href="@{/changePasswordTP}">
                                <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                                Change Password
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                                <i class="fas fa-sign-out-alt fa-sm fa-f-w mr-2 text-gray-400"></i>
                                Logout
                            </a>
                        </div>
                    </li>

                </ul>
            </nav>
            <!-- End of Topbar -->
            <!-- Begin Page Content -->
            <div class="container-fluid">
                <div class="container mt-5">
                    <div class="card">
                        <div class="card-header">
                            <h5>Manage Profile</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <form>
                                        <div class="form-group">
                                            <label for="firstName">First Name</label>
                                            <input type="text" class="form-control" id="firstName" placeholder="Enter First Name">
                                        </div>
                                        <div class="form-group">
                                            <label for="email">Email</label>
                                            <input readonly type="email" class="form-control" id="email" placeholder="Enter Email">
                                        </div>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <form>
                                        <div class="form-group">
                                            <label for="lastName">Last Name</label>
                                            <input type="text" class="form-control" id="lastName" placeholder="Enter Last Name">
                                        </div>

                                        <div class="form-group">
                                            <label for="mobile">Mobile Number</label>
                                            <input  type="tel" class="form-control" id="mobile" placeholder="Enter Mobile Number">
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" onclick="updateProfile()" id="updateProfileBtn">Update</button>
                        </div>
                    </div>

                    <div class="card mt-5">
                        <div class="card-header">
                            <h5>Manage Service Locations</h5>
                        </div>
                        <div class="card-body">
                            <form>
                                <div class="form-group">
                                    <label for="stateDropdown">State</label>
                                    <select readonly id="stateDropdown" class="form-select form-control" aria-label="Default select example">

                                    </select>
<!--                                    <select class="selectpicker form-control"  id="stateDropdown"  data-live-search="true">-->
<!--                                    </select>-->
                                </div>
                                <div class="form-group">
                                    <label for="district">District</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="selectAllDistrict">
                                        <label class="form-check-label" for="selectAllDistrict">Select All</label>
                                    </div>

                                    <select multiple class="form-select form-control mt-2" id="district">
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taluka">Taluka</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="selectAllTaluka">
                                        <label class="form-check-label" for="selectAllTaluka">Select All</label>
                                    </div>
                                    <select multiple class="form-control mt-2" id="taluka">
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="card-footer">
                            <button type="button" onclick="updateLocation()" class="btn btn-primary" id="updateServicesBtn">Save</button>
                        </div>
                    </div>
                    <div class="card mt-5">
                        <div class="card-header">
                            <h5>Upload Payment QR Code</h5>
                        </div>
                        <div class="card-body">
                            <form>
                                <div class="form-group">
<!--                                    <label for="qrCode">Upload Payment QR Code</label>-->
                                    <input type="file" class="form-control-file" id="qrCode" accept="image/*" onchange="previewQRCode(event)">
                                </div>
                                <div id="imagePreview" class="mt-3"></div>
                            </form>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" onclick="uploadQRCode()">Upload</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- End of Main Content -->
            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Logistic Management System 2024</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <a class="btn btn-primary" th:href="@{/login}">Logout</a>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap core JavaScript-->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>


<!-- Core plugin JavaScript-->
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>


<!-- Custom scripts for all pages-->
<script src="/js/sb-admin-2.min.js"></script>

<script th:inline="javascript">
    let taulkaList = []
    let profile={}
    const storage = firebase.storage();

    $(document).ready(function(){
        loadStates();
        loadDistricts();
        getProfileDetails()


        setTimeout(() => {
            getProviderAreaList();
        },200)
        // Function to select all options in District dropdown
        $('#selectAllDistrict').change(function(){

            if($(this).prop('checked')){
                $('#district option').prop('selected', true);
            } else {
                $('#district option').prop('selected', false);
            }
            updateSelectAllText(this, $('#district'));
        });

        // Function to select all options in Taluka dropdown
        $('#selectAllTaluka').change(function(){
            if($(this).prop('checked')){
                $('#taluka option').prop('selected', true);
            } else {
                $('#taluka option').prop('selected', false);
            }
            updateSelectAllText(this, $('#taluka'));
        });

        // Function to handle individual district selection
        $('#district').change(function(){
            var selectedDistricts = $(this).val();
            if(selectedDistricts){
                selectedDistricts = selectedDistricts.join(',')
            }
            loadTaluka(selectedDistricts)
            updateSelectAllText($('#selectAllDistrict'), $(this));
        });

        // Function to handle individual taluka selection
        $('#taluka').change(function(){
            updateSelectAllText($('#selectAllTaluka'), $(this));
        });

        // Function to update text of "Select All" checkbox
        function updateSelectAllText(checkbox, selectElement) {
            var allSelected = selectElement.find('option').length === selectElement.find('option:selected').length;
            checkbox.prop('checked', allSelected);
            checkbox.next('.form-check-label').text(allSelected ? 'Deselect All' : 'Select All');
        }




        function loadStates(){
            $.ajax({
                url: "/states", // Assuming the API endpoint is at this URL
                type: "GET",
                dataType: "json",
                success: function(response) {
                    // Handle successful response
                    console.log("States loaded:", response);
                    // Populate dropdown with states
                    $.each(response, function(index, state) {
                        console.log(state)
                        $('#stateDropdown').append($('<option>', {
                            value: state.id,
                            text: state.name
                        }));
                    });
                },
                error: function(xhr, status, error) {
                    // Handle error
                    console.error("Error loading states:", error);
                }
            });
                // AJAX call to fetch all states

        }

        function loadDistricts(){
            $.ajax({
                url: "/districts", // Assuming the API endpoint is at this URL
                type: "GET",
                dataType: "json",
                success: function(response) {
                    // Handle successful response
                    console.log("States loaded:", response);
                    // Populate dropdown with states
                    $.each(response, function(index, district) {
                        $('#district').append($('<option>', {
                            value: district.id,
                            text: district.districtName
                        }));
                    });
                },
                error: function(xhr, status, error) {
                    // Handle error
                    console.error("Error loading states:", error);
                }
            });
            // AJAX call to fetch all states

        }




    });
    function updateLocation(){
        let talukaList = $('#taluka').val();
        let districtList = $('#district').val();
        console.log(talukaList,districtList)
        $.ajax({
            url: '/updateProviderArea',
            method: 'POST',
            contentType: 'application/json', // Set contentType to indicate JSON data
            data: JSON.stringify( talukaList ), // Convert data to JSON string
            success: function(response) {
               window.location.reload()
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error(error);
            }
        });
    }

    function getProviderAreaList(){

        $.ajax({
            url: '/providerArea',
            method: 'GET',
            success: function(response) {
                console.log(response);
                if(response.talukaList){
                    taulkaList = response.talukaList;
                }
                else{
                    taulkaList= [];
                }
                if(response.districtList){
                    let districtIds = [];
                    response.districtList.forEach((value) => {
                        districtIds.push(value.id)
                        $('#district option[value="' + value.id + '"]').prop('selected', true);
                    })
                    loadTaluka(districtIds.join(","), true)

                }
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error(error);
            }
        });
    }

    function loadTaluka(selectedDistricts,isSetValues = false){
        $.ajax({
            url: '/talukas',
            method: 'GET',
            data: { districts: selectedDistricts },
            success: function(response) {
                // Clear existing options in the taluka dropdown
                $('#taluka').empty();

                // Append new talukas based on the response
                $.each(response, function(index, taluka) {
                    $('#taluka').append($('<option>', {
                        value: taluka.id,
                        text: taluka.talukatName
                    }));
                });

                if(taulkaList.length){
                    taulkaList.forEach((value) => {
                        $('#taluka option[value="' + value.id + '"]').prop('selected', true);
                    })
                }
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error(error);
            }
        });
    }

    function updateProfile(){
        let payload = {
            firstName:  $('#firstName').val(),
            lastName: $('#lastName').val(),
            mobileNo: $('#mobile').val()
        }

        $.ajax({
            url: '/updateProfile',
            method: 'PUT',
            contentType: 'application/json', // Set contentType to indicate JSON data
            data: JSON.stringify( payload ), // Convert data to JSON string
            success: function(response) {
                window.location.reload()
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error(error);
            }
        });
    }
    function getProfileDetails(){
        $.ajax({
            url: "/me",
            type: "GET",
            dataType: "json",
            success: function(response) {
                // Handle successful response
                console.log("API call successful");
                console.log("Response:", response);
                profile=response
                if(response && response.qrCodePath){
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(response.qrCodePath );
                    displayImage(imageRef)
                }
                // Example: Display fetched data on the page
                $('#firstName').val(response.firstName);
                $('#lastName').val(response.lastName);
                $('#email').val(response.email);
                $('#mobile').val(response.mobileNo);
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error("Error occurred while fetching data from API");
                console.error("Status:", status);
                console.error("Error:", error);
            }
        });
    }

    function previewQRCode(event) {
        const qrCodeDisplay = document.getElementById('imagePreview');
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function(event) {
            qrCodeDisplay.innerHTML = `<img src="${event.target.result}" class="img-fluid" alt="QR Code Preview">`;
        };

        reader.readAsDataURL(file);
    }

    function uploadQRCode() {
        const fileInput = document.getElementById('qrCode');

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.type.startsWith('image/')) {
                uploadFile(file)
            } else {
            }
        } else {
            alert('Please select a file.');
        }
    }


    function uploadFile(file){
        const storageRef = storage.ref();
        let fileName = "truck_provider_QR_code/"+profile.id + "_"+profile.firstName;
        const imageRef = storageRef.child(fileName );


        // Upload file to Firebase Storage
        imageRef.put(file).then(() => {

            uploadQRCodeInDb(fileName);
            displayImage(imageRef)
        }).catch((error) => {
            console.error('Error uploading image: ', error);
        });
    }

    function uploadQRCodeInDb(path) {
        // Make AJAX request
        $.ajax({
            url: '/upload/qrCode',
            type: 'POST',
            contentType: 'application/json',
            data: path,
            success: function(data) {
                alert('QR code uploaded successfully:');
            },
            error: function(xhr, status, error) {
                console.error('Error uploading QR code:', error);
                // Handle error, if needed
            }
        });
    }
    function displayImage(imageRef) {
        imageRef.getDownloadURL().then((url) => {
            const imageContainer = document.getElementById('imagePreview');
            imageContainer.innerHTML = `<img src="${url}" alt="Uploaded Image">`;
        }).catch((error) => {
            console.error('Error getting download URL: ', error);
        });
    }
</script>
</body>

</html>